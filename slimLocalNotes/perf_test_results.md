# Perf Testing Results

## Query17

query17	434.591	239.864	220.23	293.537		251.2103333	97.45166667	0.612071425	constraint join reordering	
query17	251.886	167.107	184.293	153.399		168.266333	14.5076667	0.91378152	one longer run	
query17	165.585	157.739	166.794	257.878		194.137	25.870667	0.79201114

This query needs about 16GB worth of data according to HDFS Counters

- Runs after purge cache 

00:02:56 = 176 seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124022044_c2038c39-16a0-4a94-bf88-78c240d1f492

00:02:27 = 147s sec -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124022612_f8485b46-667a-4611-931f-44237b55fd55

3m 8s 427ms = 188 sec ->  http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124023240_e044092c-3d9c-491c-a117-7f5b135db6a8 

155.321 sec -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124023807_118cdf09-45a2-40d3-a7de-2d67c61fb3e9

-- Increased the hive.llap.task.scheduler.locality.delay=500000
 
5m 1s 894ms -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124024309_c2aa3d76-2d30-4aa0-b692-b3c05cb06dd0

3m 46s 45ms = 230.241 seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124025315_77cf4334-7a2f-400d-b5cd-89ce173e5e06

-- go back to 5 sec task locality config

2m 41s 776ms = (165.787 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124030038_bb80aedb-4e80-42b2-ae59-a689c1d1a129 

-- loaded the cache with some other data to 99%
4m 38s 358ms (282.85 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124033618_528468d6-f0bf-4903-ab77-91872ee76004

 2m 36s 576ms (161.208 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124034503_8e8b92cb-babf-415a-95f5-7a6030ef8430

This Query is reading about 20G from HDFS and we can not get a hit rate above 60% after 5 runs starting from clean cache using the purge command. Also execution time has pretty intersting variance. Increased the hive.llap.task.scheduler.locality.delay=500000
still i don't get near 65 even after multiple runs.
Also the cache is about 30% full (got 9 nodes and 32G of cache per node)

AVG -> 165 seconds with clean cache 

## Query25

------------------------------

query25	199.417	183.425	156.84	149.776		163.347	42.05233333	0.742558276			
query25	155.959	125.757	110.665	126.658		121.026667	-0.268	1.00221439		
query25	145.921	218.682	112.8	115.088		148.856667	27.83	0.81484202

------------------------------
query29	451039	840.393	286.018	337.878		488.0963333	296.49	0.392558436	constraint join reordering		
query29	247.784	218.107	224.354	209.712		217.391	25.7846667	0.88139037		
query29	256.537	366.11	234.152	366.521		322.261	104.87	0.59456879


------------------------------
# Query 37 
has about 14_399_964_710 in  tpcds_bin_partitioned_orc_10000.catalog_sales

query37	74.384	35.902	26.872	22.602		28.45866667	12.96533333	0.544415292			
query37	46.943	21.223	15.057	12.822		16.3673333	0.874	0.94660095		
query37	47.512	26.735	17.928	14.45		19.7043333	3.337	0.78629066

First run with clean cache 
Time taken:  27.196 seconds ->http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124183558_f865bc0a-0743-4ee5-8102-71ff8f38b502 
CACHE_MISS_BYTES 43_273_400_602

28.027 seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124182745_891292ca-f562-4436-a8f1-79ba048e52fa

17.413 seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124182847_8c210644-c1b6-4529-866b-cb9ee5a36df5

12.842 seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124182927_ffd01541-c0e3-4055-916a-efb07e73b436  HIT Cache 37_252_452_035 37_252_452_035 MISS 6_029_071_176

12.046 seconds-> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124183025_4ad05b62-5867-4e8a-9dee-cc9157fe0101

AVG -> 19 sec
------------------------------

query5	391.297	310.405	342.83	322.243		325.1593333	184.609	0.43225065
query5	228.533	201.764	244.825	180.892		209.160333	68.61	0.67197413		
query5	378.444	192.192	344.255	172.431		236.292667	27.132334	0.59481462

------------------------------
query54	178.204	119.239	109.38	107.778		112.1323333	36.21533333	0.677030413			
query54	114.54	117.81	118.75	107.47		114.676667	38.7596667	0.66200913	longer ss scan	
query54	169.894	143.886	144.19	118.291		135.455667	20.779	0.56045643
------------------------------

## Query7
query7	68.389	49.13	26.156	25.484		33.59	11.80766667	0.648476729			
query7	64.874	37.263	29.476	24.935		30.558	8.77566667	0.71281934		
query7	60.537	38.468	34.138	27.403		33.3363333	2.7783333	0.65341119

### Observation 
If you look at TOTAL IO Time for the run with non clean cache and the one with clean cache

1268 432 038 585
Running with messy cache 
52s 872ms (54.944 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124035349_9892bade-b62a-4864-aa1b-b21fb980f014


(40.885 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124035619_9101acd9-0229-4b46-9a23-aee35520e6a5

 (25.428 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124035916_c3bba5fe-5318-4fc3-b308-965145396ee1

 (22.517 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124040041_7e273831-f80a-42b5-835e-ea4aab1c5083

 (25.081 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124040142_4bb198e2-257f-4551-8779-7916115e6a58

 -- Did purge the cache 
 (35.597 seconds) http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124040319_b2c6a762-3fec-4679-ba72-886bfc875826


  (19.18 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124040511_32c0bff5-09c8-4aa4-8309-54f6b2c51fc3

  (16.753 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124040639_d1247fc4-c168-4310-a176-1718e2d5bbff
  (17.163 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124040717_e5525d91-d705-4f5b-9d61-4dbcd61c7fc0

  (16.658 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124040750_d02c327e-9567-495a-b762-107131394e9f

  -- back here after messy cache 
  (60.991 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124050329_6891b566-df17-4851-9816-9e2d4e040b98

  (36.552 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124050541_af4dcefb-5312-45a2-a765-e64228c1a3d4

  (29.36 seconds) - > http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124050722_2a4adddc-e866-4139-9187-7a6cf8cc7033

  -- purge the cache again

  (31.278 seconds)-> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124050833_68f101e2-70ec-4259-a89f-de0613ec7fd1

  (19.57 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124051642_7ee1d767-e2b1-4c3a-9459-8267672382a6

  (16.612 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124051735_a4cc243e-a52c-4f78-9b7a-41878b2f0ae5 

   (17.105 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124051922_5a2779df-7aee-46fb-b5b4-4b0470f7d9c9
------------------------------

## query76

query76	451.039	322.347	300.09	300.52		307.6523333	66.42266667	0.784098284	longer ss scan		
query76	651.079	414.187	276.769	276.769		322.575	81.3453333	0.74782505	longer ss scan	
query76	346.887	335.847	329.329	294.762		319.979333	-2.595667	0.7538914

First run with 30% full cache 
 5m 54s 42ms (358.31 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124031915_6a0bdcd3-d984-40cf-8184-3e9978a4b5fc

(373.253 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124032908_edaf5a5f-a30b-40ea-9059-5a3a345dbdcd

-- Cleaned the cache

(369.641 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124041353_ac5ba91e-b4d9-4217-abf5-4a929ed8a097

5m 55s 715ms (359.578 seconds) http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124042136_7c36a324-4c78-4ce2-aa0c-7515778edd7b

(359.998 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124042918_1570704c-c380-48e1-92dc-a5ba8384d4ce

UP till here cache hit is very low HIT 1255933856 , MISS 365836285904 and the cache use rate is 99%, Thus even after pruge cache 
i see that in some case like this query that needs about 300G of data from HDFS

(373.172 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124043740_745c4bc1-cb06-4d79-ba8d-fc2915c676ac Cache miss 367090873979 Cache Hit 1345781

(364.591 seconds) -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124044852_8b194886-e7ff-41cf-b8b3-4e7865807456

------------------------------

## query82

query82	67.447	43.702	33.732	31.856		36.43	16.00033333	0.560792387			
query82	74.391	49.511	31.015	25.874		35.4666667	15.037	0.57602444		
query82	77.052	49.346	37.511	32.037		39.6313333	4.1646666	0.51549279

First run with 40% full cache Time taken: 91.746 seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124183906_421f28f2-aa4c-4b98-9a0b-3477aed14ef2

Clean cache first run
59 seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124184153_0f6b9f89-1b8e-4d52-98e7-53aa9230fe61

40 Seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124184344_16fbaa65-2634-4594-bdde-bd1b88075d58

28 seconds -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124184517_8818d9d6-a220-4fd9-ac44-72470e3e8fb3

22 sec -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124185002_1ad9d167-65bc-482a-919d-fffd0e2ccba6

22 sec -> http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124185213_3ecaf0dc-72dd-4a47-b947-12e2fb8b6b73 


Avg 28 sec without the first run 
------------------------------
## query85

query85	130.408	119.172	102.451	99.757		107.1266667	32.81566667	0.693674155			
query85	129.92	103.592	111.933	103.296		106.273667	31.9626667	0.69924189		
query85	134.093	120.369	100.397	88.467		103.077667	-3.196	0.72092241
------------------------------

## query88
this one 
query88	116.373	95.476	99.452	80.492		91.80666667	18.64466667	0.796913804			
query88	113.159	107.454	105.298	107.707		106.819667	33.6576667	0.68491133		
query88	128.61	110.349	105.265	103.49		106.368	-0.451667	0.68781965

Clean cache run 
121.841 sec 
------------------------------

## query9

query9	375.899	289.837	264.595	236.508		263.6466667	117.8663333	0.552938276	query changed in 3.0		
query9	334.171	241.996	217.951	208.904		222.950333	77.17	0.6538691	new query	
query9	312.772	255.312	224.06	207.94		229.104	6.153667	0.63630636

------------------------------

## query90

query90	54.357	27.881	16.822	14.813		19.83866667	5.292	0.733248202			
query90	51.008	24.72	16.433	16.268		19.1403333	4.59366667	0.7600007		
query90	51.075	33.158	20.867	16.474		23.4996667	4.3593334	0.61901587

first run with messy cache 

46 sec http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124185951_e10f325a-5065-44f9-94db-8e692d11afd0

21.585 seconds 2 http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124190049_b5a5754b-3b4c-4e2a-b6a6-4f15b733ae20

Cleanned the cache

22.723 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124190217_cac44694-3f5a-4ac9-aa01-e5c7f01876fe

16.333 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124190258_57995644-9e26-441f-a16e-3fa369f20b06

16.358 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124190357_85c402c6-316e-4714-bf95-5a2a7308fea7

15 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124190454_702e3007-316c-4994-8bce-e2011d6baa9a

------------------------------
## query95

query95	340.357	281.784	282.445	385.865		316.698	152.0883333	0.51976857	https://hortonworks.jira.com/browse/BUG-113691		
query95	272.4	252.329	246.904	232.918		244.050333	79.4406667	0.67449064	semijoins changed	
query95	281.423	241.332	242.852	230.688		238.290667	-5.759666	0.6907936

after clean cache 
362.507 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124191557_78ecb3a1-cdff-432d-a743-3fda1d58403a

230.203

After clean cache Time taken: 245.82 seconds using hive.optimize.joinreducededuplication=false

run 2 Time taken: 238.116 seconds
------------------------------
## query96
query96	71.847	51.55	44.926	39.876		45.45066667	18.22533333	0.599008449			
query96	98.498	69.477	54.763	42.518		55.586	28.3606667	0.4897876		
query96	91.581	64.83	58.538	51.488		58.2853333	2.6993333	0.46710436

clean cache 
82.976 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124190832_894c4a74-741f-4ec6-95e0-0856cc60948d

51.766 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124191017_2c09b2d0-e7cb-4278-8fa2-958d1bf98b8e

49.038 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124191204_7a3d7498-56e1-4a78-8a5a-ebb880fc96ab

39.542 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124191308_05427f88-6aec-4132-b71b-d66608527998

37.347 seconds http://ctr-e138-1518143905142-420129-01-000002.hwx.site:30800/#/query/root_20190124191404_4c29ddeb-b9e4-41c2-b790-99f2941fb6c1


------------------------------
------------------------------
